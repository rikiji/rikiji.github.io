<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>CVE-2013-2094 port to x86</title>
    <meta name="author" content="@rikiji">
    <meta name="description" content="a blog">
    <meta name="viewport" content="width=device-width">
    <link href="atom.xml" type="application/atom+xml" rel="alternate">

    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/styles/main.css">
    <script src="/scripts/vendor/modernizr.js"></script>
    <script src="/scripts/vendor/jquery-1.9.1.min.js"></script>
    <script type="text/javascript">
      var addthis_config = {"data_track_clickback":false };
      var addthis_share = {templates : {twitter : ": "}}      
    </script>
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4f7391fd6bf055cd"></script>
    <link href="http://fonts.googleapis.com/css?family=Didact+Gothic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Crimson+Text:400,600" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700,300" rel="stylesheet" type="text/css">
  </head>
  <body>

    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <div class="row-fluid">
      <div id="content" class="span9">
	<div class="top">
  <h2><a href="http://rikiji.it/2013/05/10/CVE-2013-2094-x86.html">CVE-2013-2094 port to x86</a></h2>
  <h3>May 10 2013</h3>
</div>
<div class="post">
  
  <p>TL;DR: (<a href="https://gist.github.com/anonymous/40996630379660447f85">perf_ptmx.c</a>)</p>

<p>Last week on <a href="https://news.ycombinator.com/item?id=5703758">HN</a> a link to a linux local privilege escalation exploit was posted, exploit which affects all linux versions between 2.6.37 and 3.8.9 compiled with PERF_EVENTS enabled. Some distros backported the bug to older kernel versions too, I tested CentOS 2.6.32-358.el6.x86_64 as vulnerable. The security issue is located in <a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/kernel/events/core.c?id=8176cced706b5e5d15887584150764894e94e02f">kernel/events/core.c</a>, and it has been introduced in a <a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=b0a873ebbf87bf38bf70b5e39a7cadc96099fa13">commit</a> which added the functions <code class="highlighter-rouge">perf_swevent_init</code> and <code class="highlighter-rouge">sw_perf_event_destroy</code>.</p>

<p>The problem lies in the fact that the value <code class="highlighter-rouge">event-&gt;attr.config</code>, which is stored in the struct <code class="highlighter-rouge">perf_event_attr</code> as u64, is being checked for validity after being casted to a signed int. The check is done with:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>if (event_id &gt; PERF_COUNT_SW_MAX)
  return -ENOENT;
</code></pre>
</div>

<p>This means that any value of <code class="highlighter-rouge">event-&gt;attr.config</code> which has in the lower 4 bytes a negative value will pass the check and will later be used as index for the array <code class="highlighter-rouge">perf_swevent_enabled</code>. Known the address of the base of the array, it is possible (with some limitations) to increment/decrement arbitrary memory locations in kernel space. The vulnerability was <a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=8176cced706b5e5d15887584150764894e94e02f">fixed</a> just changing the <code class="highlighter-rouge">event_id</code> type to u64.</p>

<p>Full credit to sd@fucksheep.org for releasing the exploit (linked above). The original exploit targets specifically the x86_64 architecture, and I’ve now ported it to x86 Debian. The original version worked by incrementing the highest 4 bytes <code class="highlighter-rouge">base_hi</code> in the x86_64 IDT entry of interrupt 4, from 0xffffffff to 0x00000000, and then mapping the corresponding memory region in userspace, filling it with some shellcode to raise the privileges of the running process.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>struct _idt_entry_64 {
  unsigned short base_lo;
  unsigned short sel;
  unsigned char unused;
  unsigned char flags;
  unsigned short base_mi;
  unsigned int base_hi;
  unsigned int zero;
} __attribute__((packed));

struct _idt_entry {
  unsigned short base_lo;
  unsigned short sel;
  unsigned char unused;
  unsigned char flags;
  unsigned short base_hi;
} __attribute__((packed));
</code></pre>
</div>

<p>Since on x86 the IDT struct  is different from the x86_64 one this approach can’t be used. On Debian <code class="highlighter-rouge">perf_swevent_enabled</code> is a pointer to a struct of 4 bytes, so targeting IDT makes no sense because even if we can increment any memory location multiple times (check the next paragraph to see how), <code class="highlighter-rouge">base_hi</code> (of any interrupt) could be incremented only pointing to flags (because the granularity of the pointer we can manipulate is 4 bytes and the IDT is aligned in memory), therefore requiring more than 64k increments to increase <code class="highlighter-rouge">base_hi</code> only by 1.</p>

<p>An idea from <a href="http://www.reddit.com/user/spender">/u/spender</a> is to call multiple times <code class="highlighter-rouge">perf_event_open</code> while keeping the file descriptors open, avoiding the destroy callback which will revert the change done in the init function. In this way is is possible to increment a value in kernel space multiple times. This has the drawback of the process hitting the maximum number of open file descriptors allowed very fast, so some forking is required. I browsed a bit the kernel source to find a function pointer initialized to zero which was not stored in read only memory, and I chose to leverage <code class="highlighter-rouge">drivers/tty/pty.c</code>, a driver for ptmx devices, which is enabled in the default Debian kernel and has <code class="highlighter-rouge">struct file_operations ptmx_fops</code>, which has some NULL pointers and more importantly is not in read only memory.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/* 56 is offset of fsync in struct file_operations */
int target = pmtx_ops + 56;
int payload = -((perf_table - target)/4)

struct perf_event_attr event_attr;
event_attr.config = payload;
...
/* many many times */
syscall(__NR_perf_event_open, &amp;event_attr, 0, -1, -1, 0);
...
int ptmx = open("/dev/ptmx", O_RDWR);
fsync(ptmx);
</code></pre>
</div>

<p>The exploit resolves a few symbols names using System.map, maps some memory at 0x10000 right after <code class="highlighter-rouge">vm.mmap_min_addr</code> and fills it with privilege escalation code, then computes the offset of the <code class="highlighter-rouge">fsync</code> pointer for the pseudo terminal device in relation to <code class="highlighter-rouge">perf_swevent_enabled</code>. The syscall <code class="highlighter-rouge">perf_event_open</code> is called exactly 0x10000 times spread among multiple processes. The shellcode is then executed opening <code class="highlighter-rouge">/dev/ptmx</code> and calling <code class="highlighter-rouge">fsync</code> on it. When the processes terminate/close the fd returned by the syscall, clean up will be done automatically by <code class="highlighter-rouge">sw_perf_event_destroy</code>.</p>

<p><a href="http://zmbs.net/~rikiji/perf_ptmx.c">source code</a>, <code class="highlighter-rouge">gcc perf_ptmx.c &amp;&amp; ./a.out</code>.</p>

  
  <div class="addthis_toolbox addthis_default_style" addthis:url="http://rikiji.it/2013/05/10/CVE-2013-2094-x86.html" addthis:title="CVE-2013-2094 port to x86" addthis:description="TL;DR: (perf_ptmx.c) Last week on HN a link to a linux local privilege escalation exploit was posted, exploit which affects...">
    <a class="addthis_button_reddit"></a>    
    <a class="addthis_button_facebook"></a>
    <a class="addthis_button_twitter"></a>
    <a class="addthis_button_google_plusone" g:plusone:count="false"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>

</div>
<hr>

	<div class="bottom">	  
	  <div>
	    <img class="pic" src="http://rikiji.it/images/me4.jpg">
	    <p class="desc">I am Riccardo, I studied computer engineering at the University of Trieste (Italy) and then got a M.Sc. in the same field at the University of Stuttgart (Germany). I now live in Zurich, Switzerland.</p>
	    <p>You should follow me on twitter: <a href="https://twitter.com/rikiji" class="twitter-follow-button" data-show-count="false">Follow @rikiji</a></p>
	    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	  </div>
	  <p class="eof">EOF</p>
	</div>


      </div>
      <div id="sidebar" class="span3">
	<div class="sidebar-nav sidebar-nav-fixed">
	  <h1><a href="http://rikiji.it">rikiji</a></h1>
	  <hr>
	  <ul class="unstyled">
	    <li><a href="http://rikiji.it/posts.html">posts</a> <i class="icon-comment"></i> </li>
	    <li><a target="_blank" href="https://twitter.com/rikiji">twitter</a> <i class="icon-twitter"></i></li>
	    <li><a target="_blank" href="https://github.com/rikiji">github</a> <i class="icon-github-alt"></i></li>
	    <li><a target="_blank" href="https://plus.google.com/108443252369367751910?rel=author">google+</a> <i class="icon-google-plus"></i></li>
	    <li><a class="mail" href="mailto:rikiji foo rikiji dot it">mail</a> <i class="icon-envelope-alt"></i></li>
	    <li><a href="http://rikiji.it/about.html">about</a> <i class="icon-user"></i></li>
	  </ul>
	</div>
      </div>
    </div>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
    <script>
      var _gaq=[['_setAccount','UA-30381469-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>

    <script src="/scripts/main.js"></script>
  </body>
</html>
