<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>On ruby's garbage collector</title>
    <meta name="author" content="@rikiji">
    <meta name="description" content="a blog">
    <meta name="viewport" content="width=device-width">
    <link href="atom.xml" type="application/atom+xml" rel="alternate">

    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/styles/main.css">
    <script src="/scripts/vendor/modernizr.js"></script>
    <script src="/scripts/vendor/jquery-1.9.1.min.js"></script>
    <script type="text/javascript">
      var addthis_config = {"data_track_clickback":false };
      var addthis_share = {templates : {twitter : ": "}}      
    </script>
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4f7391fd6bf055cd"></script>
    <link href="http://fonts.googleapis.com/css?family=Didact+Gothic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Crimson+Text:400,600" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700,300" rel="stylesheet" type="text/css">
  </head>
  <body>

    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <div class="row-fluid">
      <div id="content" class="span9">
	<div class="top">
  <h2><a href="http://rikiji.it/2013/03/01/on-rubys-garbage-collector.html">On ruby's garbage collector</a></h2>
  <h3>March 01 2013</h3>
</div>
<div class="post">
  
  <p>Ruby 2.0 features a new garbage collection algorithm, called Bitmap Marking. To understand how this new approach works, a brief look at the ruby design is needed, starting with <strong>ruby.h</strong>.</p>

<p>All ruby objects are referenced through variables of the type <code class="highlighter-rouge">VALUE</code> in the C code: a <code class="highlighter-rouge">VALUE</code> is an unsigned integer that can be an immediate value (integer, float, symbol, true, false , nil) or a pointer to a <code class="highlighter-rouge">RBasic</code> structure. A <code class="highlighter-rouge">RBasic</code> structure holds two fields, <code class="highlighter-rouge">flags</code> and <code class="highlighter-rouge">klass</code>. There are many macros that can be used to check the type of an object just by accessing those flags, <code class="highlighter-rouge">BUILTIN_TYPE</code> is one of those and it is defined as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#define BUILTIN_TYPE(x) (int)(((struct RBasic*)(x))-&gt;flags &amp; T_MASK)
</code></pre>
</div>

<p>The type of an object can be one of those in the enum <code class="highlighter-rouge">ruby_value_type</code>, some of them are:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>enum ruby_value_type {
RUBY_T_NONE   = 0x00,

RUBY_T_OBJECT = 0x01,
RUBY_T_CLASS  = 0x02,
RUBY_T_MODULE = 0x03,
RUBY_T_FLOAT  = 0x04,
RUBY_T_STRING = 0x05,
RUBY_T_REGEXP = 0x06,
RUBY_T_ARRAY  = 0x07,
RUBY_T_HASH   = 0x08,
RUBY_T_STRUCT = 0x09,
RUBY_T_BIGNUM = 0x0a,
RUBY_T_FILE   = 0x0b,
RUBY_T_DATA   = 0x0c,
RUBY_T_MATCH  = 0x0d,
RUBY_T_COMPLEX  = 0x0e,
RUBY_T_RATIONAL = 0x0f,
   	...
</code></pre>
</div>

<p>So how does it work in practice? Let’s have a look at <code class="highlighter-rouge">RString</code>: it is a struct that holds a <code class="highlighter-rouge">RBasic</code> struct inside. When you want to check if a <code class="highlighter-rouge">VALUE</code> is a string, the first thing that <code class="highlighter-rouge">rb_type(VALUE obj)</code> does is to check if it is an immediate value. If not, it will be cast to <code class="highlighter-rouge">RBasic</code> and the flags will be accessed by <code class="highlighter-rouge">BUILTIN_TYPE</code>. The result can be compared to <code class="highlighter-rouge">RUBY_T_STRING</code>: if it matches, it is safe to cast (again) the <code class="highlighter-rouge">VALUE</code> to <code class="highlighter-rouge">RString</code>. Please note that the <code class="highlighter-rouge">RBasic</code> structure is still accessible with the new pointer, as it is included into <code class="highlighter-rouge">RString</code>!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>struct RString {
struct RBasic basic;
union {
    struct {
	long len;
	char *ptr;
	union {
	    long capa;
	    VALUE shared;
	} aux;
    } heap;
    char ary[RSTRING_EMBED_LEN_MAX + 1];
} as;
};
</code></pre>
</div>

<p>RString has actually more features than RBasic, it can contain an array of characters directly (on a 32 bits system the max size is 12 + 1 bytes) or it can contain a reference to a string allocated elsewhere. Casting <code class="highlighter-rouge">RBasic</code> structures to other types is valid for all ruby objects, and this feature is exploited by the GC to allocate space easily.</p>

<p>Now that the basic strategies of <code class="highlighter-rouge">VALUE</code> handling used by the ruby interpreter are known, we can move on to <strong>gc.c</strong>. <code class="highlighter-rouge">RVALUE</code> is a wrapper structure used to hold any of the previously discussed ones. This is the base “unit” that will be used to allocate and free memory.</p>

<div class="highlighter-rouge"><pre class="highlight"><code> typedef struct RVALUE {
union {
    struct {
	VALUE flags;		/* always 0 for freed obj */
	struct RVALUE *next;
    } free;
    struct RBasic  basic;
    struct RObject object;
    struct RClass  klass;
    struct RFloat  flonum;
    struct RString string;
    struct RArray  array;
    struct RRegexp regexp;
    struct RHash   hash;
    struct RData   data;
    struct RTypedData   typeddata;
    struct RStruct rstruct;
    struct RBignum bignum;
    struct RFile   file;
    struct RNode   node;
    struct RMatch  match;
    struct RRational rational;
    struct RComplex complex;
} as;
} RVALUE;
</code></pre>
</div>

<p>Ruby tracks allocated memory in structures called <code class="highlighter-rouge">heaps_slot</code>. Each of them includes a pointer to a linked list of <code class="highlighter-rouge">RVALUE</code> structures. Let’s follow the flow of the code when a new object is created, I cut out not relevant lines:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>static VALUE
newobj(VALUE klass, VALUE flags)
{
rb_objspace_t *objspace = &amp;rb_objspace;
VALUE obj;

...

obj = (VALUE)objspace-&gt;heap.free_slots-&gt;freelist;
objspace-&gt;heap.free_slots-&gt;freelist = RANY(obj)-&gt;as.free.next;
if (objspace-&gt;heap.free_slots-&gt;freelist == NULL) {
    unlink_free_heap_slot(objspace, objspace-&gt;heap.free_slots);
}

MEMZERO((void*)obj, RVALUE, 1);
objspace-&gt;total_allocated_object_num++;

return obj;
}
</code></pre>
</div>

<p>A <code class="highlighter-rouge">RVALUE</code> object is taken from a global freelist and the head of the list is shifted forwards.
This <code class="highlighter-rouge">obj</code> is a pointer to a memory area which is big enough to store any ruby structure: <code class="highlighter-rouge">RString</code>, <code class="highlighter-rouge">RArray</code>… When this list becomes empty, the GC is called and it will try to free some <code class="highlighter-rouge">RVALUE</code>. If not possible, a new <code class="highlighter-rouge">heaps_slot</code> (or more) will be allocated.</p>

<p>Now that is known how objects are allocated, we can inspect the two phases of the garbage collector. The phases are named <strong>mark</strong> and <strong>sweep</strong>. In the first phase all the objects still reachable are marked. In the sweep phase all the objects not marked are identified and added to the freelist we mentioned before. Additionally, while traversing the lists all marks are reset to prepare the objects for the next GC round.</p>

<p>Starting from the function <code class="highlighter-rouge">garbage_collect</code>, we can dig into the mark phase, handled by the function <code class="highlighter-rouge">gc_marks</code>.  The real job is done by the function <code class="highlighter-rouge">gc_mark_stacked_objects</code>, which consists in a giant switch-case statement that handles all the <code class="highlighter-rouge">RVALUE</code> subtypes differently. In the sweep phase, which starts in <code class="highlighter-rouge">gc_sweep</code>, all the <code class="highlighter-rouge">RVALUE</code> objects without a mark are added to the freelist that is used to allocate new objects.</p>

<p>In the next post I’ll focus on the improvements introduced by the garbage collector of Ruby 2.0 and maybe provide some benchmark result.</p>

  
  <div class="addthis_toolbox addthis_default_style" addthis:url="http://rikiji.it/2013/03/01/on-rubys-garbage-collector.html" addthis:title="On ruby's garbage collector" addthis:description="Ruby 2.0 features a new garbage collection algorithm, called Bitmap Marking. To understand how this new approach works, a brief...">
    <a class="addthis_button_reddit"></a>    
    <a class="addthis_button_facebook"></a>
    <a class="addthis_button_twitter"></a>
    <a class="addthis_button_google_plusone" g:plusone:count="false"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>

</div>
<hr>

	<div class="bottom">	  
	  <div>
	    <img class="pic" src="http://rikiji.it/images/me4.jpg">
	    <p class="desc">I am Riccardo, I studied computer engineering at the University of Trieste (Italy) and then got a M.Sc. in the same field at the University of Stuttgart (Germany). I now live in Zurich, Switzerland.</p>
	    <p>You should follow me on twitter: <a href="https://twitter.com/rikiji" class="twitter-follow-button" data-show-count="false">Follow @rikiji</a></p>
	    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	  </div>
	  <p class="eof">EOF</p>
	</div>


      </div>
      <div id="sidebar" class="span3">
	<div class="sidebar-nav sidebar-nav-fixed">
	  <h1><a href="http://rikiji.it">rikiji</a></h1>
	  <hr>
	  <ul class="unstyled">
	    <li><a href="http://rikiji.it/posts.html">posts</a> <i class="icon-comment"></i> </li>
	    <li><a target="_blank" href="https://twitter.com/rikiji">twitter</a> <i class="icon-twitter"></i></li>
	    <li><a target="_blank" href="https://github.com/rikiji">github</a> <i class="icon-github-alt"></i></li>
	    <li><a target="_blank" href="https://plus.google.com/108443252369367751910?rel=author">google+</a> <i class="icon-google-plus"></i></li>
	    <li><a class="mail" href="mailto:rikiji foo rikiji dot it">mail</a> <i class="icon-envelope-alt"></i></li>
	    <li><a href="http://rikiji.it/about.html">about</a> <i class="icon-user"></i></li>
	  </ul>
	</div>
      </div>
    </div>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
    <script>
      var _gaq=[['_setAccount','UA-30381469-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>

    <script src="/scripts/main.js"></script>
  </body>
</html>
